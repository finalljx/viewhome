<html>
<head>
	<title>请示审批</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1.0"/>
	<script type="application/javascript" src="../assets/iscroll.js"></script>
	<link rel="stylesheet" href="../lib/jquery-mobile/jquery.mobile-latest/jquery.mobile.min.css" /> 
	<link rel="stylesheet" href="../assets/jquery.mobile-sugon.css" /> 
	<script src="../lib/jquery/jquery.min.js"></script>		
	<script src="../lib/encrypt/encrypt.js"></script>
	<script src="../lib/json/json2.js"></script>
	<script src="../lib/hori/hori.js?tag=21369"></script>
	<script src="../config/web/config.js"></script>
	<script src="../lib/jquery-mobile/jquery.mobile-latest/jquery.mobile.min.js"></script>
	<script type="text/javascript">
		function pullUpAction () {
			var getMoreData = localStorage.getItem("getMoreData");
			if(getMoreData=="issuedoc"){
				getIssuedocList();
			}else if(getMoreData=="receivedoc"){
				getReceivedocList();
			}
		}
		function loaded() {
			pullUpEl = document.getElementById('pullUp');	
			pullUpOffset = pullUpEl.offsetHeight;
			myScroll = new iScroll('wrapper', {
				useTransition: true,
				topOffset: pullUpOffset,
				onRefresh: function () {
				if (pullUpEl.className.match('loading')) {
					pullUpEl.className = '';
					pullUpEl.querySelector('.pullUpLabel').innerHTML = '';
				}
			},
			onScrollMove: function () {
				if (this.y < (this.maxScrollY - 5) && !pullUpEl.className.match('flip')) {
					pullUpEl.className = 'flip';
					pullUpEl.querySelector('.pullUpLabel').innerHTML = '';
					this.maxScrollY = this.maxScrollY;
				} else if (this.y > (this.maxScrollY + 5) && pullUpEl.className.match('flip')) {
					pullUpEl.className = '';
					pullUpEl.querySelector('.pullUpLabel').innerHTML = '';
					this.maxScrollY = pullUpOffset;
				}
			},
			onScrollEnd: function () {
				if (pullUpEl.className.match('flip')) {
					pullUpEl.className = 'loading';
					pullUpEl.querySelector('.pullUpLabel').innerHTML = '';
					pullUpAction();
				}
			}
			});
		}
	
		$(document).ready(function(){
			var hori = $.hori;
			/*设置标题*/
			hori.setHeaderTitle("公文查阅");
			$.hori.showLoading();
			loaded();
			$("#tabs").tabs({beforeActivate:function(event,ui){
					//alert(ui.newTab.context.dataset.id);
					tabid=ui.newTab.context.dataset.id;
					//发文
					if(tabid=="issuedocList"){
						localStorage.setItem("getMoreData","issuedoc");
						starNumber=1;
						getIssuedocList();
					}
					//收文
					if(tabid=="receivedocList"){
						localStorage.setItem("getMoreData","receivedoc");
						starNumber=1;
						getReceivedocList();
					}
			}})
			//localStorage.setItem("officialVal","1");
			var onlist=localStorage.getItem("officialVal");
			if(onlist=="1"){
				$("#ui-id-1").click()
				 getIssuedocList();
			}
			if(onlist=="2"){
				$("#ui-id-2").click()	
			}
			
		})
	
		//发文列表
		var starNumber=1;
		function getIssuedocList(){
			$.hori.showLoading();
			localStorage.setItem("getMoreData","issuedoc");
			var issuedoc = localStorage.getItem("issuedoc");
			var url = $.hori.getconfig().appServerHost+"view/oa/issuedocList/"+issuedoc+"/AppDoingView?readviewentries?login&start="+starNumber+"&count=10";
			$.hori.showLoading();
			$.hori.ajax({
				"type":"post",
				"url":url,
				"success":function(res){
					$("#receivedocDataList").empty();
					$("#moredata").remove();
					if(res.indexOf("无内容")!="-1"){
						var divs = document.getElementsByName("nodata");
						for(var i=0; i<divs.length; i++)
						{
							divs[i].style.display='none';
						}
					}
					$("#issuedocDataList").append(res).listview("refresh");
					starNumber = parseInt($("#issuedocDataList a:last").attr("data-endNumber"))+1;
					$.hori.hideLoading();
					
					myScroll.refresh();
				},
				"error":function(res){
					$.hori.hideLoading();
				}
			});
		}
	
		//收文列表
		function getReceivedocList(){
			localStorage.setItem("getMoreData","receivedoc");
			var receivedoc = localStorage.getItem("receivedoc");
			var url = $.hori.getconfig().appServerHost+"view/oa/receivedocList/"+receivedoc+"/AppDoingView?readviewentries?login&start="+starNumber+"&count=10";
			$.hori.showLoading();
			$.hori.ajax({
				"type":"post",
				"url":url,
				"success":function(res){
					$("#issuedocDataList").empty();
					$("#moredata").remove();
					if(res.indexOf("无内容")!="-1"){
						var divs = document.getElementsByName("nodata");
						for(var i=0; i<divs.length; i++)
						{
							divs[i].style.display='none';
						}
					}
					$("#receivedocDataList").append(res).listview("refresh");
					starNumber = parseInt($("#receivedocDataList a:last").attr("data-endNumber"))+1;
					$.hori.hideLoading();
					myScroll.refresh();
				},
				"error":function(res){
					$.hori.hideLoading();
				}
			});
		}
		var t1 = null;//这个设置为全局
	//发文详情页
	function loadIssuedocPage(str){
		if (t1 == null){
	        t1 = new Date().getTime();
	    }else{       
	        var t2 = new Date().getTime();
	        if(t2 - t1 < 500){
	            t1 = t2;
	            return;
	        }else{
	            t1 = t2;
	        }
	    }
		var docunid = $(str).data("unid");
		localStorage.setItem("Issuedocdocunid",docunid);
		var issuedoc = localStorage.getItem("issuedoc");
		/*if (window.navigator.userAgent.match(/iPad/i) || window.navigator.userAgent.match(/iPhone/i) || window.navigator.userAgent.match(/iPod/i)||window.navigator.userAgent.match(/android/i)){
			var oaurl =$.hori.getconfig().appServerHost+"view/oa/issuedocPage/"+issuedoc+"/AppDoingView/"+docunid+"?opendocument&login"+'?editdocument&data-application=' + $.hori.getconfig().appKey + "&data-userstore=" + localStorage.getItem("cookie_userstore");
		}else{
			var oaurl =$.hori.getconfig().appServerHost+"view/oa/issuedocPage/"+issuedoc+"/AppDoingView/"+docunid+"?opendocument&login";
		}*/
		var oaurl=issuedoc+"/AppDoingView/"+docunid+"?opendocument&login";
 		localStorage.setItem("oaDataSource",oaurl);
		var targetURL= $.hori.getconfig().serverBaseUrl+"viewhome/html/issuedocPage.html";
		targetURL=encodeURI(targetURL);
		$.hori.loadPage(targetURL);
	}
	//收文详情页
	function loadReceivedocPage(str){
		if (t1 == null){
	        t1 = new Date().getTime();
	    }else{       
	        var t2 = new Date().getTime();
	        if(t2 - t1 < 500){
	            t1 = t2;
	            return;
	        }else{
	            t1 = t2;
	        }
	    }
		var docunid = $(str).data("unid");
		localStorage.setItem("Receivedocdocunid",docunid);
		var receivedoc = localStorage.getItem("receivedoc");
		/*if (window.navigator.userAgent.match(/iPad/i) || window.navigator.userAgent.match(/iPhone/i) || window.navigator.userAgent.match(/iPod/i)||window.navigator.userAgent.match(/android/i)){
			var oaurl = $.hori.getconfig().appServerHost+"view/oa/receivedocPage/"+receivedoc+"/AppDoingView/"+docunid+"?opendocument&login"+'?editdocument&data-application=' + $.hori.getconfig().appKey + "&data-userstore=" + localStorage.getItem("cookie_userstore");
		}else{
			var oaurl = $.hori.getconfig().appServerHost+"view/oa/receivedocPage/"+receivedoc+"/AppDoingView/"+docunid+"?opendocument&login";
		}*/
		var oaurl=receivedoc+"/AppDoingView/"+docunid+"?opendocument&login";
		localStorage.setItem("oaDataSource",oaurl);
		var targetURL= $.hori.getconfig().serverBaseUrl+"viewhome/html/receivedocPage.html";
		targetURL=encodeURI(targetURL);
		$.hori.loadPage(targetURL);
	}
	</script>
	<style>
		#wrapper {
			position: fixed;
			overflow: scroll;
			top: 100px;
			bottom: 1.5em;
			width: 98%;
		}
		.ui-content .ui-listview-inset, .ui-panel-inner.ui-listview-inset {
			margin: 0em 0;
		}
	</style>
</head>
<body>
	<div data-role="page" style="margin:0px;padding:0px;">
		<div data-role="content">
			<div data-role="tabs" id="tabs">
		      	<div data-role="navbar">
					<ul>
						<li><a href="#two" data-ajax="false" data-id="issuedocList">发文</a></li>
						<li><a href="#three" data-ajax="false" data-id="receivedocList">收文</a></li>
					</ul>
				</div>
				<div id="wrapper">
					<div id="scroller">
					  <div id="pullDown"></div>
					  <div id="two">
							<ul id="issuedocDataList"  data-role="listview" data-inset="true">
								<li id="moredata" style="display:none"><div id="pullUp" align="center">
									<span class="pullUpLabel">上划加载更多...</span>
								</div></li>
							</ul>
							<br/>
					  </div>
					  <div id="three">
						   <ul id="receivedocDataList" data-role="listview" data-inset="true">
								<li id="moredata" style="display:none"><div id="pullUp" align="center">
										<span class="pullUpLabel">上划加载更多...</span>
									</div></li>
						   </ul>
							<br/>
					  </div>
				   </div>
			   </div>
		    </div>
		</div>
	</div>
</body>
</html>

