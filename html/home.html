<html class="ui-mobile"><head>
<title>首页</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1.0">
<link rel="stylesheet" href="../assets/home/jquery-mobile-home.css">
<script src="../lib/jquery/jquery.min.js"></script>
<script src="../lib/jquery-cookie/jquery.cookie.js"></script>
<script src="../lib/encrypt/encrypt.js"></script>
<script src="../lib/json/json2.js"></script>
<script src="../lib/hori/hori.js?tag=21369"></script>
<script src="../config/web/config.js"></script>
<script type="text/javascript">
function openmail(){
	if (window.navigator.userAgent.match(/iPad/i) || window.navigator.userAgent.match(/iPhone/i) || window.navigator.userAgent.match(/iPod/i)) {
		window.location.href="mailto:";

	} else if (window.navigator.userAgent.match(/android/i)) {
		var runMail=new cherry.bridge.NativeOperation("application", "runTraveler", []).dispatch();
		var travelerScript = new cherry.bridge.ScriptOperation(function(){
				var result = runMail.returnValue;
				if(!result || result==false || result=='false'){
				alert('请先安装traveler客户端!');
				}
				});
		travelerScript.addDependency(runMail);
		travelerScript.dispatch();
		cherry.bridge.flushOperations();
	}
}


//气泡中待办数量
function inittodos(){
	if (icount!=gcount){
		
		$.hori.showLoading();
		var url = $.hori.getconfig().appServerHost+"view/oamobile/todosnum/Produce/GeneralMessage.nsf/GetAllMsgInfoAgent?openagent&random="+Math.random();
		$.hori.ajax({
				"type":"post",
				"url":url,
				"data":"data-xml=yes^~^app|8|vwTaskUnDoneForMobile|vwTaskUnDoneForMobile^~^msg|5|msgByDateDownUnRdView|msgByDateDownRdView^~^flowinfo|5|FlowUndoView|FlowDoneView",
				"success":function(res){
					var json = JSON.parse(res);
					if(json.exception!=""){
						alert(json.exception);
						$.hori.hideLoading();
					}else{
						$("#spanTodo").html(json.number);
						icount= gcount;
						$.hori.hideLoading();
					}
				},
				"error":function(res){
					$.hori.hideLoading();
				}
			})
	}
}
/*
   调整气泡位置
 */
function adjustBubble(){
	var imgOffset=$("#imgToDo").offset();
	var divOneOffset=$("#divOne").offset();
	var spanTodo=$("#spanTodo").get(0);
	spanTodo.style.position="fixed";
	//68为图片宽度
	if(window.navigator.userAgent.match(/iPad/i) || window.navigator.userAgent.match(/iPhone/i) || window.navigator.userAgent.match(/iPod/i)) {
		spanTodo.style.top=divOneOffset.top-10;
		spanTodo.style.left=imgOffset.left+78;

	}else if(window.navigator.userAgent.match(/android/i)) {

		spanTodo.style.top=divOneOffset.top-10;
		spanTodo.style.left=imgOffset.left+68+10;
	}else{
		//alert('other')
		spanTodo.style.top=divOneOffset.top;
		spanTodo.style.left=imgOffset.left+68+10;

	}	
}
var gcount=1;
var icount=0;

	$(document).ready(function() {
		try {
			var hori = $.hori;
			/*设置标题*/
			hori.setHeaderTitle("首页");
			/*隐藏后退按钮*/
			hori.hideBackBtn();
			/*注册注销事件*/
			hori.registerEvent("case", "navButtonTouchUp", function() {
				hori.backPage(1);
			});
			//刷新气泡显示代办条数
			hori.registerEvent("case", "casePresented", function() {
				//alert("niubility");
				// 调用代办条数
				inittodos();
			});
			// 调整气泡位置
			adjustBubble();
			//如果浏览器调试模式显示气泡数
			if ($.hori.browerDebug) {
				inittodos();
			}
			//ios 隐藏邮件图标
			if (hori.getMobileType() == "apple") {
				$("#divMail").hide();
			}
			//获取公文库
			getOfficialLibrary();
		} catch (e) {
			alert(e.message);
		}

	});
	//待办
	function loadTaskList() {
		$.hori.showLoading();
		createUser();
		gcount = gcount + 1;
		var targetUrl = $.hori.getconfig().serverBaseUrl
				+ "viewhome/html/task.html"

		$.hori.loadPage(encodeURI(targetUrl));

	}
	//已办
	function loadDoneTaskList() {
		$.hori.showLoading();
		gcount=gcount+1;
		var targetUrl = $.hori.getconfig().serverBaseUrl
				+ "viewhome/html/downTask.html"
		$.hori.loadPage(encodeURI(targetUrl));

	}
	//通知公告
	function loadAnnouceList() {
		$.hori.showLoading();
		
		var targetUrl = $.hori.getconfig().serverBaseUrl

				+ "viewhome/html/annouceList.html"
		$.hori.loadPage(encodeURI(targetUrl));

	}
	//通讯录
	function loadContact() {
		$.hori.showLoading();
		$.hori.loadPage($.hori.getconfig().serverBaseUrl
				+ 'viewhome/html/contact.html',
				$.hori.getconfig().serverBaseUrl
						+ 'viewhome/xml/searchContact.xml')
	}
	//公文查阅
	function officialDocument() {
		var officialLibrary = localStorage.getItem("officialLibrary");
		if(officialLibrary=="no"){
			alert("您没有配置公文库，请联系OA管理员，谢谢。");
			return false;
		}
		localStorage.setItem("officialVal","1");
		$.hori.showLoading();
		var targetUrl = $.hori.getconfig().serverBaseUrl+"viewhome/html/officialDocument.html"
		$.hori.loadPage(encodeURI(targetUrl));
	}
	function loadConnections() {
		$.hori.runApp("com.ibm.lotus.connections.mobile1",
		"com.ibm.lotus.connections.mobile.pages.LotusConnections",
		function(res) {
		if (res == "true") {
		console.log("启动Connections客户端");
		} else {
		alert("您没有安装Connections客户端，请安装后再试");
		}
		});
		}
	//获取公文库
	function getOfficialLibrary() {
		var url = $.hori.getconfig().appServerHost+"view/oa/officialDocumentLibrary/Produce/WeboaConfig.nsf/GetGongWenByUser?openAgent&itcode=&data-result=text";
		$.hori.ajax({
			"type" : "post",
			"url" : url,
			"success" : function(res) {
				console.log(res);
				var resJson = JSON.parse(res);
				//当前登录人有公文
				if(resJson.issue){
					localStorage.setItem("officialLibrary","yes");
					//发文库 resJson.issue 
					localStorage.setItem("issuedoc", resJson.issue);
					//收文库 resJson.receive
					localStorage.setItem("receivedoc", resJson.receive);
				}else{
					localStorage.setItem("officialLibrary","no");
				}
				
			},
			"error" : function(res) {
				alert("获取公文路径异常！");
			}
		})
	}
	function createUser() {
		var url = $.hori.getconfig().appServerHost
				+ "view/oa/?data-action=createuser";
		$.hori.ajax({
			"type" : "get",
			"url" : url,
			"data" : "",
			"success" : function(res) {
				//alert(res);
			},
			"error" : function(res) {
				
			}
		})

	}
	
</script>
<style>
a {
	text-decoration: none;
}

.bubble-count {
	font-size: 11px;
	font-weight: bold;
	padding: .2em .5em;
	margin-left: -.5em;
}
</style>
</head>
<body class="ui-mobile-viewport ui-overlay-c">
	<div data-role="page" id="home" style="background-image: url(../assets/home/bg_empty.jpg); min-height: 100%; background-position: initial initial; background-repeat: repeat repeat;" data-url="home" tabindex="0" class="ui-page ui-body-c ui-page-active">
		<div data-role="content" align="center" class="ui-content" role="main">
			<div class="ui-grid-b" id="divOne">
				<div class="ui-block-a">
					<a href="javascript:void(0);" onclick="loadTaskList()" class="ui-link"> <img id="imgToDo" width="68" height="68" src="../assets/home/task.png">
					</a> <span id="spanTodo" class="bubble-count ui-btn-up-c ui-btn-corner-all" style="position: fixed; top: 15px; left: 359.5px;">0</span> <br>
					<span style="color: #434343"><strong>待办任务</strong></span>
				</div>
				<div class="ui-block-b">
					<a href="javascript:void(0)" onclick="loadDoneTaskList()" class="ui-link"> <img width="68" height="68" src="../assets/home/tel.png">
					</a> <br> <span style="color: #434343"><strong>已办任务</strong></span>
				</div>
				<div class="ui-block-c">
					<a href="javascript:void(0);" onclick="officialDocument()" class="ui-link"> <img width="68" height="68" src="../assets/home/mail.png">
					</a> <br> <span style="color: #434343"><strong>公文查阅</strong></span>
				</div>
			</div>
			<br>
			<div class="ui-grid-b" id="divOne">
				<div class="ui-block-a">
					<a href="javascript:void(0)" onclick="loadAnnouceList()" class="ui-link"> <img width="68" height="68" src="../assets/home/tel.png">
					</a> <br> <span style="color: #434343"><strong>通知公告</strong></span>
				</div>
				<div class="ui-block-b">
					<a href="javascript:void(0)" onclick="loadContact()" class="ui-link"> <img width="68" height="68" src="../assets/home/tel.png">
					</a> <br> <span style="color: #434343"><strong>电话查询</strong></span>
				</div>
				<div class="ui-block-c" id="divMail">
					<a href="javascript:void(0);" onclick="openmail()" class="ui-link"> <img width="68" height="68" src="../assets/home/mail.png">
					</a> <br> <span style="color: #434343"><strong>个人邮件</strong></span>
				</div>
			</div>
			<br>
			<div class="ui-grid-b" id="divOne">
				<div class="ui-block-a">
					<a href="javascript:void(0)" onclick="loadConnections()" class="ui-link"> <img width="68" height="68" src="../assets/home/tel.png">
					</a> <br> <span style="color: #434343"><strong>Connection</strong></span>
				</div>
				<div class="ui-block-b">
					
				</div>
				<div class="ui-block-c">
					
				</div>
			</div>
		</div>
	</div>

</body></html>