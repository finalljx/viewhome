<!DOCTYPE html>
<html>
<head>
<title>移动办公</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1.0" />
<script type="application/javascript" src="../../assets/iscroll.js"></script>
<link rel="stylesheet"
	href="../../lib/jquery-mobile/jquery.mobile-latest/jquery.mobile.min.css" />
<link rel="stylesheet" href="../../assets/jquery.mobile-sugon.css" />
<script src="../../lib/jquery/jquery.min.js"></script>
<script src="../../lib/encrypt/encrypt.js"></script>
<script src="../../lib/json/json2.js"></script>
<script src="../../lib/hori/hori.js?tag=21369"></script>
<script src="../../config/web/config.js"></script>
<script
	src="../../lib/jquery-mobile/jquery.mobile-latest/jquery.mobile.min.js"></script>
<script src="../../lib/knockout/knockout.js"></script>
<script src="../../lib/knockout/knockout.mapping.js"></script>
<style>
a {
	text-decoration: none;
}

.ui-content .ui-listview, .ui-panel-inner>.ui-listview {
	margin: 0;
}

.ui-li-has-count .ui-li-count {
	position: absolute;
	top: 50%;
	margin-top: -.9em;
	right: 5px;
}
.ui-date-item {
	border: none;
	background: transparent;
	background-image: none;
	font-size: 15px;
}

#wrapper {
	position: fixed;
	top: 10px;
	bottom: 0px;
	left: 0px;
	width: 100%;
}

.department_name {
	color: blue;
}
</style>
<script type="text/javascript">
	var itcode;
	var moreCurrentName;
	$(document).ready(function() {
		itcode = localStorage.getItem("itcode");
		moreCurrentName = localStorage.getItem("moreCurrentName");
		//默认隐藏列表显示
		$("#newsList").css("display", "none");
		switch (moreCurrentName) {
		case "GT_HomePage_SiteArea_jttz":
			$.hori.setHeaderTitle("集团通知");
			break;
		case "GT_HomePage_SiteArea_jtxw":
			$.hori.setHeaderTitle("集团新闻");
			break;
		case "GT_HomePage_SiteArea_zgsxw":
			$.hori.setHeaderTitle("成员单位新闻");
			break;
		case "GT_HomePage_SiteArea_kjdt":
			$.hori.setHeaderTitle("科技动态");
			break;
		case "GT_HomePage_SiteArea_pmgg":
			$.hori.setHeaderTitle("聘免公告");
			break;
		case "GT_HomePage_SiteArea_aqsc":
			$.hori.setHeaderTitle("安全环保");
			break;
		case "GT_HomePage_SiteArea_zcfg":
			$.hori.setHeaderTitle("政策法规");
			break;

		}
		//加载集团通知列表
		pullUpAction(itcode);
	});
	var myScroll, pullDownEl, pullDownOffset, pullUpEl, pullUpOffset, generatedCount = 0;
	var str = null;
	var jsonData = new Object();
	var page = 0;
	var viewModel = new Object();
	function pullUpAction(itcode) {
		$.hori.showLoading();
		setTimeout(
				function() {
					
					page = page + 1;
					var url = $.hori.getconfig().appServerHost
							+ "view/news/newsList/accsyWcmNews/services/WcmNewsList";
					var temp = "$lt;?xml version='1.0' encoding='utf-8'?$gt;$lt;root$gt;$lt;newslist$gt;$lt;type$gt;"
							+ moreCurrentName
							+ "$lt;/type$gt;$lt;userid$gt;"
							+ itcode
							+ "$lt;/userid$gt;$lt;pageSize$gt;10$lt;/pageSize$gt;$lt;parent$gt;1$lt;/parent$gt;$lt;pageNow$gt;"
							+ page
							+ "$lt;/pageNow$gt;$lt;/newslist$gt;$lt;/root$gt;";
					var soap = "<soapenv:Envelope xmlns:soapenv='http://schemas.xmlsoap.org/soap/envelope/' xmlns:web='http://webservice.biz.digiwin.com'>";
					soap += '<soapenv:Header/><soapenv:Body>';
					soap += '<web:getWcmNewsList>';
					soap += '<web:in0>' + temp + '</web:in0>';
					soap += '</web:getWcmNewsList>';
					soap += ' </soapenv:Body></soapenv:Envelope>';
					var data = "data-xml=" + soap;
					$.hori
							.ajax({
								"type" : "post",
								"url" : url,
								"data" : data,
								"success" : function(res) {
									$.hori.hideLoading();
									$("#newsList").css("display", "");
									$("#divDataLoading").css("display", "none");
									var list = JSON.parse(res);
									/* for ( var item in list) {
										var targetURL = "http://10.1.32.61/appdata/WcmNewsImage/" + list[item].contentName + "/"
												+ list[item].newName;
										list[item].imgSrc = targetURL;
									} */
									var myDate = new Date();
									for (var i = 0; i < list.length; i++) {
										if (moreCurrentName == 'GT_HomePage_SiteArea_zgsxw') { //如果为成员单位新闻，添加新闻所属公司
											list[i].contentTitle = "["
													+ list[i].department + "]"
													+ list[i].contentTitle;
										}
										var time = list[i].creatTime.substr(0,
												4);
										if (time == myDate.getFullYear()) {
											list[i].creatTime = list[i].creatTime
													.substr(5, 9);
											
											list[i].creatTime = "["
												+ list[i].creatTime + "]";
										} else {
											
										}
									}
									if (page == 1) {
										jsonData.list = list;
										render();
										myScroll.refresh();
									} else {
										if (list.length < 10) {
											$('#pullUpLabel').text("没有更多数据！");
										}
										var tmpViewModel = ko.mapping
												.fromJS(list);
										for (var i = 0; i < list.length; i++) {
											viewModel.list
													.push(tmpViewModel()[i]);
										}
										myScroll.refresh();
									}
									$.hori.hideLoading();
								},
								"error" : function(res) {
									alert("error:" + res);
									$.hori.hideLoading();
								}
							});
				}, 1000);
	}
	function render() {
		viewModel = ko.mapping.fromJS(jsonData);
		ko.applyBindings(viewModel);
		$('#querydataList')
				.append(
						'<li id="moredata" class="ui-li-static ui-body-inherit ui-last-child"><div id="pullUp" align="center"><span class="pullUpLabel">上划加载更多...</span></div></li>');
		loaded();
	}

	function loaded() {
		pullUpEl = document.getElementById('pullUp');
		pullUpOffset = pullUpEl.offsetHeight;
		myScroll = new iScroll(
				'wrapper',
				{
					useTransition : true,
					topOffset : pullUpOffset,
					onRefresh : function() {
						if (pullUpEl.className.match('正在加载中...')) {
							pullUpEl.className = '';
							pullUpEl.querySelector('.pullUpLabel').innerHTML = '上拉加载更多...';
						}
					},

					onScrollMove : function() {
						if (this.y < (this.maxScrollY - 5)
								&& !pullUpEl.className.match('flip')) {
							pullUpEl.className = 'flip';
							pullUpEl.querySelector('.pullUpLabel').innerHTML = '上拉加载更多...';
							this.maxScrollY = this.maxScrollY;
						} else if (this.y > (this.maxScrollY + 5)
								&& pullUpEl.className.match('flip')) {
							pullUpEl.className = '';
							pullUpEl.querySelector('.pullUpLabel').innerHTML = '上拉加载更多...';
							this.maxScrollY = pullUpOffset;
						}
					},
					onScrollEnd : function() {

						if (pullUpEl.className.match('flip')) {
							pullUpEl.className = '正在加载中...';
							pullUpEl.querySelector('.pullUpLabel').innerHTML = '正在加载中...';
							pullUpAction(itcode);
						}
					}
				});
	}
	var t1 = null;//这个设置为全局
	//跳转新闻详情页
	function showDetail(item) {
		if (t1 == null){
	        t1 = new Date().getTime();
	    }else{       
	        var t2 = new Date().getTime();
	        if(t2 - t1 < 500){
	            t1 = t2;
	            return;
	        }else{
	            t1 = t2;
	        }
	    }
		var contentName = item.contentName();
		localStorage.setItem("currentContentName", contentName);
		$.hori.showLoading();
		$.hori.loadPage($.hori.getconfig().serverBaseUrl
				+ 'viewhome/html/news/newsDetail.html');
	}
</script>
</head>
<body>
	<div id="list" data-role="page" class="type-home">
		<div data-role="content" align="center">
			<div id="divDataLoading">
				<ul data-role="listview" data-inset="true">
					<li>数据加载中……</li>
				</ul>
			</div>
			<div id="newsList">
				<div id="wrapper">
					<div id="scroller">
						<p></p>
						<ul data-bind="foreach: list" id="querydataList" data-role="listview" >
							<li data-icon="false">
							<a data-bind="click:showDetail" style="line-height:2.5em;padding-right:5em;">
									<!-- ko text: contentTitle --> <!-- /ko -->
									<span class="ui-li-count ui-date-item" data-bind="text:creatTime"/>
							</a></li>
						</ul>
					</div>
				</div>
			</div>
</body>
</html>
