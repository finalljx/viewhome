<!DOCTYPE html>
<html>
<head>
<title>收入利润趋势</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1.0" />
<link rel="stylesheet"
	href="../../lib/jquery-mobile/jquery.mobile.min.css" />
<script src="../../lib/jquery/jquery.min.js"></script>
<script src="../../lib/jquery-cookie/jquery.cookie.js"></script>
<script src="../../lib/encrypt/encrypt.js"></script>
<script src="../../lib/json/json2.js"></script>
<script src="../../lib/hori/hori.js?tag=21369"></script>
<script src="../../lib/jquery-mobile/jquery.mobile.min.js"></script>
<script src="../asset/js/echarts-plain.js"></script>
<script src="../../config/web/config.js"></script>
<script src="../../lib/knockout/knockout.js"></script>
<script src="../../lib/knockout/knockout.mapping.js"></script>
<style>
a {
	text-decoration: none;
}

@media only screen and (min-width: 1070px) and (max-width: 1242px) {
	#month {
		font-size: 17px;
	}
}

@media screen and (min-width: 400px) and (max-width: 800px) {
	#month {
		font-size: 16px;
	}
}

@media screen and (min-width: 310px) and (max-width: 330px) {
	#month {
		font-size: 15px;
	}
}
</style>
</head>
<body>
	<div id='month'
		style="float: right; display: none; margin-bottom: 15px;">
		注：此经营数据截至<span data-bind="text: reportdata.year"></span>年<span
			data-bind="text: reportdata.month"></span>月。
	</div>
	<!-- 收入利润趋势 -->
	<div id="main"></div>
	<p></p>
	<div id="main1"></div>

	<script type="text/javascript">
	var myChart;
	var myChart1;
		window.onload = function() {
			var h = (document.documentElement.clientHeight) / 2;//可见区域高度
			var w = document.documentElement.clientWidth;//可见区域高度
			var sm = document.getElementById('main');
			//h= parseInt(h)-5;
			sm.style.height = h + "px";
			sm.style.width = w + "px";
			var ss = document.getElementById('main1');
			ss.style.height = h + "px";
			ss.style.width = w + "px";

		}

		$(document).ready(function() {
			$.hori.setHeaderTitle("收入利润趋势");
			//加载收入利润趋势图表数据
			/* $.hori.registerEvent("case", "caseClosed", function() {
                if(myChart){
                	console.log("caseClosed:" + new Date());
                	myChart.clear();
                	myChart.dispose();
                	console.log("caseClosed:" + myChart);
                }
                if(myChart1){
                	myChart1.clear();
                	myChart1.dispose();
                }
            }); */
			loadSrlrqsChart();
		});
		//加载收入利润趋势图表数据
		function loadSrlrqsChart() {
			$.hori.loading();
			var url = $.hori.getconfig().appServerHost
					+ "view/bi/loadSrlrqsChart/accsyBiReport/services/reqBiReportData";
			var temp = "$lt;?xml version='1.0' encoding='utf-8'?$gt;$lt;root$gt;$lt;reportdata$gt;$lt;reportid$gt;6$lt;/reportid$gt;$lt;/reportdata$gt;$lt;/root$gt;";
			var soap = "<soapenv:Envelope xmlns:soapenv='http://schemas.xmlsoap.org/soap/envelope/' xmlns:web='http://webservice.biz.digiwin.com'>";
			soap += '<soapenv:Header/><soapenv:Body>';
			soap += '<web:viewReportById>';
			soap += '<web:in0>' + temp + '</web:in0>';
			soap += '</web:viewReportById>';
			soap += ' </soapenv:Body></soapenv:Envelope>';
			var data = "data-xml=" + soap;
			var viewModel;

			$.hori.ajax({
				"type" : "post",
				"url" : url,
				"data" : data,
				"success" : function(res) {

					var json = JSON.parse(res);
					console.log(res);
					render(json);
					$("#month").css('display', '');
					var cWidth = window.screen.width;
					if (cWidth < 730) {
						fontSize = 15;
						fontSize2 = 13;
					} else {
						fontSize = 18;
						fontSize2 = 16;
					}
					var income = json.reportdata.income;
					var profit = json.reportdata.profit;
					var month = income.statMonth.split('|');
					var seriesname = income.seriesname.split('|');
					var lastSumData = income.lastSumData.split('|');
					var nowSumData = income.nowSumData.split('|');
					var increaseData = income.increaseData.split('|');
					var yearBudget = income.yearBudget.split('|');
					loadSrlrqs(month, seriesname, lastSumData, nowSumData,
							increaseData, yearBudget, fontSize);
					var month2 = income.statMonth.split('|');
					var seriesname2 = profit.seriesname.split('|');
					var lastSumData2 = profit.lastSumData.split('|');
					var nowSumData2 = profit.nowSumData.split('|');
					var increaseData2 = profit.increaseData.split('|');
					var yearBudget2 = profit.yearBudget.split('|');
					loadSrlrqs2(month2, seriesname2, lastSumData2, nowSumData2,
							increaseData2, yearBudget2, fontSize);

					$.hori.loading("hide");
				},
				"error" : function(res) {
					alert("error:" + res);
					$.hori.loading("hide");
					$.hori.hideLoading();
				}
			});
		}
		function render(parsedStr) {
			viewModel = ko.mapping.fromJS(parsedStr);
			ko.applyBindings(viewModel, document.getElementById('month'));
		}
		
		function loadSrlrqs(month, seriesname, lastSumData, nowSumData,
				increaseData, yearBudget) {
			var option = {
				animation : false,
				tooltip : {
					trigger : 'axis',
				/* position : function(p) {
					// 位置回调
					// console.log && console.log(p);
					return [ p[0] - 70, p[1] ];
				}, */
				},
				toolbox : {
					show : false,
					feature : {
						mark : {
							show : false
						},
						dataView : {
							show : false,
							readOnly : false
						},
						magicType : {
							show : false,
							type : [ 'line', 'bar' ]
						},
						restore : {
							show : false
						},
						saveAsImage : {
							show : false
						}
					}
				},
				calculable : false,
				legend : {
					data : seriesname,
					selectedMode : false,
					textStyle : {
						fontSize : fontSize
					}
				},
				xAxis : [ {
					type : 'category',
					data : month,
					axisLabel : {
						textStyle : {
							fontSize : fontSize
						}
					}
				} ],
				yAxis : [ {
					type : 'value',
					axisLabel : {
						formatter : '{value} 亿元',
						textStyle : {
							fontSize : fontSize2,
						}
					}
				}, {
					type : 'value',
					axisLabel : {
						formatter : '{value} ',
						textStyle : {
							fontSize : fontSize2,
						}
					}
				} ],
				series : [

				{
					name : seriesname[0],
					type : 'bar',
					data : lastSumData
				}, {
					name : seriesname[1],
					type : 'bar',
					data : nowSumData
				}, {
					name : seriesname[2],
					type : 'line',
					yAxisIndex : 1,
					data : increaseData
				}, {
					name : seriesname[3],
					type : 'line',
					yAxisIndex : 1,
					data : yearBudget
				} ]
			};
			myChart = echarts.init(document.getElementById('main'));
			myChart.setOption(option);
		}
	</script>
	<script type="text/javascript">
		function loadSrlrqs2(month2, seriesname2, lastSumData2, nowSumData2,
				increaseData2, yearBudget2) {
			var option = {
				animation : false,
				tooltip : {
					trigger : 'axis'
				},
				toolbox : {
					show : false,
					feature : {
						mark : {
							show : false
						},
						dataView : {
							show : false,
							readOnly : false
						},
						magicType : {
							show : false,
							type : [ 'line', 'bar' ]
						},
						restore : {
							show : false
						},
						saveAsImage : {
							show : false
						}
					}
				},
				calculable : false,
				legend : {
					data : seriesname2,
					selectedMode : false,
					textStyle : {
						fontSize : fontSize
					}
				},
				xAxis : [ {
					type : 'category',
					data : month2,
					axisLabel : {
						textStyle : {
							fontSize : fontSize
						}
					}
				} ],
				yAxis : [ {
					type : 'value',
					axisLabel : {
						formatter : '{value} 亿元',
						textStyle : {
							fontSize : fontSize2,
						}
					}
				}, {
					type : 'value',
					axisLabel : {
						formatter : '{value} ',
						textStyle : {
							fontSize : fontSize2,
						}
					}
				} ],
				series : [

				{
					name : seriesname2[0],
					type : 'bar',
					data : lastSumData2
				}, {
					name : seriesname2[1],
					type : 'bar',
					data : nowSumData2
				}, {
					name : seriesname2[2],
					type : 'line',
					yAxisIndex : 1,
					data : increaseData2
				}, {
					name : seriesname2[3],
					type : 'line',
					yAxisIndex : 1,
					data : yearBudget2
				} ]
			};
			myChart1 = echarts.init(document.getElementById('main1'));
			myChart1.setOption(option);
		}
	</script>

</body>
</html>
