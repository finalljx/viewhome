<!DOCTYPE html> 
<html>
	<head>
		<title>移动办公</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1.0"/>

		<link rel="stylesheet" href="../lib/jquery-mobile/jquery.mobile.min.css" /> 

		<link rel="stylesheet" href="../assets/jquery.mobile-sugon.css" /> 

		
		<script src="../lib/jquery/jquery.min.js"></script>		
		<script src="../lib/jquery-cookie/jquery.cookie.js"></script>	
		<script src="../lib/encrypt/encrypt.js"></script>
		<script src="../lib/json/json2.js"></script>
		<script src="../lib/hori/hori.js?tag=21369"></script>
		
		<script src="../lib/jquery-mobile/jquery.mobile.min.js"></script>
		
		<script src="../config/web/config.js"></script>

				
		<style>
			a{text-decoration:none;}
			.ui-corner-all{
				-webkit-border-radius: 0em;
				border-radius: 0em;
			}
			.ui-btn-corner-all {
				-webkit-border-radius: 0em;
				border-radius: 0em;
			}
		</style>
		

		<script type="text/javascript">
			$(document).ready(function(){
				try{
					var hori=$.hori;
					hori.setHeaderTitle("登录");
					/*隐藏后退按钮*/
				 	hori.hideBackBtn();
					$.hori.registerEvent("case", "casePresented", function() {
						rememberUser();
					});
					rememberUser();
				}catch(e){
					alert(e.message);
				}
			});
			function rememberUser(){
				if(localStorage.getItem("data-saveusername")=="true"){
					var username=localStorage.getItem("username");
					if(username!=null){	
						username=username;
					}
					$("#username").val(username);
					$('#saveusername').attr("checked", true).checkboxradio("refresh");
				}else{
					$("#username").val("员工编号");
					$("#username").css("color", "#9e9e9e");
					$('#saveusername').removeAttr("checked").checkboxradio("refresh");
				}
				if(localStorage.getItem("data-savepassword")=="true"){
					var password=localStorage.getItem("password");
					if(password!=null){	
						password=password;
					}
					$("#password").attr("type", "password");
					$("#password").val(password);
					$('#savepassword').attr("checked", true).checkboxradio("refresh");
				}else{
					$("#password").val("密码");
					$("#password").css("color", "#9e9e9e");
					$('#savepassword').removeAttr("checked").checkboxradio("refresh");
				}
			}
			function login(){
				var username = $.trim($("#username").val());
				var password = $("#password").val();
				if(username == ""){
					alert("请输入用户名!");
					return;
				}
				
	            
				if(password == ""){
					alert("请输入密码!");
					return;
				}
				$.hori.showLoading();

			
				try{
					var random = new Date().getTime();
					var url=$.hori.getconfig().appServerHost+"view/portal/loginvalidate/portalauth/eaiweb3/EAIServlet";
				}catch(e){}
				var data = 'uid='+username+'&passwd='+password+'&logintype=user&data-userid=Username&data-password=Password&data-login=true';
				$.hori.ajax({
						"type":"post",
						"url":url,
						"data":data,
						"success":function(res){
								var json = JSON.parse(res);
								if(json.success){
								
									//本地存储itcode 和oaServerName
									localStorage.setItem("oaServerName",$.hori.getconfig().oaServerName)
									localStorage.setItem("itcode",username);
									localStorage.setItem("password",password);
									saveUserInfoToLocal(username,password);
									
									var targetURL= $.hori.getconfig().serverBaseUrl+"viewhome/html/home.html";	
									var componentURL="";
									targetURL=encodeURI(targetURL);
									
									if(localStorage.getItem("loginRedirectUrl")!=null){
										targetURL=localStorage.getItem("loginRedirectUrl");
										localStorage.removeItem("loginRedirectUrl");
										
									}else{
										componentURL = "viewhome/xml/digihome.xml";
									}
									if(localStorage.getItem("loginRedirectXmlUrl")!=null){										
										componentURL=localStorage.getItem("loginRedirectXmlUrl");
										localStorage.removeItem("loginRedirectXmlUrl");
									}						
										
									$.hori.loadPage(targetURL, componentURL);			
									
									//注册设备
									registdevice();
														

								}else{
									$.hori.hideLoading();
									alert(json.msg);
								}

						},
						"error":function(res){
							alert(res);
							$.hori.hideLoading();
						}
					})
			}

			function showDeviceId(){
				$.hori.getDeviceId(function(deviceId){
					alert("deviceId="+deviceId);
				})
			}
			function cancel(){
				$("#username").val("");
				$("#password").val("");
			}
			function saveUserInfoToLocal(username,password){
				try{
					if(document.getElementById("saveusername").checked){
						localStorage.setItem("data-saveusername", "true");
						localStorage.setItem("username",username);
					}else{
						localStorage.setItem("data-saveusername", "false");
						
					}
					if(document.getElementById("savepassword").checked){
						localStorage.setItem("data-savepassword", "true");
						localStorage.setItem("password",password);
					}else{
						localStorage.setItem("data-savepassword", "false");
						localStorage.removeItem("password");
					}
				}catch(e){}
			}
			function registdevice(){
				var type = "android";
				if (window.navigator.userAgent.match(/iPad/i) || window.navigator.userAgent.match(/iPhone/i) || window.navigator.userAgent.match(/iPod/i)) {
					type = "iphone";
				}

				$.hori.getDeviceId(function(resultid){
						if(resultid == ""){
						alert("无法获取设备ID");
						return;
						}

						$.hori.getDeviceToken(function(resulttoken){
								if(resulttoken == ""){
								//alert("无法获取设备token");
								//return;
								}
								resulttoken = resulttoken.replace(/\s+/g,"");
								$.hori.ajax({
									type: "POST", url:  $.hori.getconfig().appServerHost+"view/oa?data-action=regisdevice&data-device-type="+type+"&data-device-token="+resulttoken+"&data-device-id="+resultid+"&random="+Math.random(),
									success: function(response){
									
									},
									error:function(response){
									}
								});
						});
				});
			}
			function clearData (){
				if($.trim($("#username").val())=="员工编号"){
					$("#username").val("");
					$("#username").css("color", "#0F0E0E");
				}else{
				}
				return false;
			}
			function showTips(){
				var userName=$.trim($("#username").val());
				if($.trim($("#username").val())==""){
					$("#username").css("color", "#9e9e9e");
					$("#username").val("员工编号");
				}else{
					$("#username").css("color", "#0F0E0E");
				}
				return false;
			}
			function clearDataPass (){
				if($.trim($("#password").val())=="密码"){
					$("#password").val("");
					$("#password").css("color", "#0F0E0E");
					$("#password").attr("type", "password");
				}else{
				}
				return false;
			}
			function showTipsPass(){
				var password=$.trim($("#password").val());
				if($.trim($("#password").val())==""){
					$("#password").css("color", "#9e9e9e");
					$("#password").val("密码");
					$("#password").attr("type", "text");
				}else{
					$("#password").css("color", "#0F0E0E");
				}
				return false;
			}
		</script>
	</head>
	<body>
        <!-- 登录页面 -->
        
		<div data-role="page" id="login" class="login">
			<div data-role="content" align="center">
			   <div class=logoDiv>
				<div class=loginLogo >
				    <img src="../assets/home/items/module-res/logo.png" style="width: 90%; height: auto;">
				    <img src="../assets/home/items/module-res/system_name.png" style="width: 90%; height: auto;">
                </div>
			   </div>
			   <input type="text" name="username"  id="username" value="" onfocus ="clearData()" onblur="showTips()"/>
			   <input type="text" name="password" id="password" value="" onfocus ="clearDataPass()" onblur="showTipsPass()"/>
					<div class="ui-grid-a">
                        <div class="ui-block-a">
							<input type="checkbox" name="saveusername" id="saveusername" data-mini="true"/>
							<label for="saveusername" data-mini="true" style="border: 0px solid #ccc;background:#F1F1F1;background-image: none;">&nbsp;&nbsp;记住帐号</label>
						</div>
						<div class="ui-block-b">
							<input type="checkbox" name="savepassword" id="savepassword" data-mini="true"/>
							<label for="savepassword" data-mini="true" style="border: 0px solid #ccc;background:#F1F1F1;background-image: none;">&nbsp;&nbsp;记住密码</label>
						</div>
                    </div>
					</li>
				</ul>
				
				<div class="ui-grid-a">
					<div class="ui-block-a" style="width: 100%">
						<a href="javascript:void(0)" onclick="login()" data-theme="f" data-role="button" >&nbsp;登&nbsp;录&nbsp;</a>
					</div>
				</div>
            </div>
			</div>
			
		</div>
	</body>
</html>
