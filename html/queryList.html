<html>
<head>
	<title>请示审批</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1.0"/>
	<script type="application/javascript" src="../assets/iscroll.js"></script>
	<link rel="stylesheet" href="../lib/jquery-mobile/jquery.mobile-latest/jquery.mobile.min.css" /> 
	<link rel="stylesheet" href="../assets/jquery.mobile-sugon.css" /> 
	<script src="../lib/jquery/jquery.min.js"></script>		
	<script src="../lib/encrypt/encrypt.js"></script>
	<script src="../lib/json/json2.js"></script>
	<script src="../lib/hori/hori.js?tag=21369"></script>
	<script src="../config/web/config.js"></script>
	<script src="../lib/jquery-mobile/jquery.mobile-latest/jquery.mobile.min.js"></script>
	<script type="text/javascript">
			var addmore = localStorage.getItem("addmore");
			var myScroll,pullUpEl, pullUpOffset,generatedCount=0;
			var Astart=1;
			var Bstart=1;
			var Cstart=1;
			var dstart=1;
			var estart=1;
			var fstart=1;
			var view="";
			var dataid = ""
			var ayeartime;
			var formtime;
			var taskListNum;
			function fiteryear(){ //过滤年份显示
				var taskListLiHideNum=0;
			    var now = new Date();
			    var year=now.getFullYear()-1;   
			    var month=now.getMonth()+1;
			    if(month<10){month="0"+month;}
			    var date=now.getDate();
			    if(date<10){date="0"+date;}
			    var hour=now.getHours();   
			    var minute=now.getMinutes();   
			    var second=now.getSeconds();
			    ayeartime=year+"-"+month+"-"+date+" "+hour+":"+minute+":"+second;
			    $("li").each(function(){
			        formtime = $(this).data("time");
			        if(ayeartime>formtime){
			            $(this).hide();
						taskListLiHideNum=taskListLiHideNum+1;
			        }else{
			        }
			    });
				var querydataListHide = localStorage.getItem("querydataListHide");
				taskListNum = taskListNum-1;
				var nodataHtml='<li name="more" class="ui-li-static ui-body-inherit ui-first-child ui-last-child"><div style="width:100%;" align="center"><h3>无内容</h3></div></li>';
				if(taskListNum==taskListLiHideNum){
					//$("#"+querydataListHide).empty();
					var divs = document.getElementsByName("more");
					for(var i=0; i<divs.length; i++)
					{
						divs[i].style.display='none';
					}
					$("#"+querydataListHide).append(nodataHtml);
					$("#moredata").hide();
					localStorage.setItem("pullUpActionVal","no");
				}else if(taskListNum<10){
					$("#moredata").hide();
					localStorage.setItem("pullUpActionVal","no");
				}
			}
			function pullUpAction () {
				//临时禁用加载更多 2014-12-25 武红宇
				return false;
				$.hori.showLoading();
				setTimeout(function () {
					try{
					var pullUpActionVal = localStorage.getItem("pullUpActionVal");
					if(pullUpActionVal=="no"){
						$.hori.loading("hide");
						$.hori.hideLoading();
						return false;
					}
					var type = localStorage.getItem("type");
					var dbpath = "";
					if(type=="searchqueryForDoing"){
						template="searchqueryForDoing";
						view = "vwDocByDate";
						dataid = "querydataList";
						dbpath="/"+$.hori.getconfig().docServer+"/genertec/dep1/qsbg_1.nsf";
						Astart=Astart+10;
						start=Astart;
					}
					if(type=="querydoing"){
						template="queryForDoing";
						view = "vwDocByDate";
						dataid = "querydataList";
						dbpath="/"+$.hori.getconfig().docServer+"/genertec/dep1/qsbg_1.nsf";
						Astart=Astart+10;
						start=Astart;
					}
					if(type=="querytoArchive"){
						template="toArchive";
						view = "vwtoArchive";
						dataid = "querydataList";
						dbpath="/"+$.hori.getconfig().docServer+"/genertec/dep1/qsbg_1.nsf";
						Bstart=Bstart+10;
						start=Bstart;
					}
					if(type=="searchquerytoArchive"){
						template="searchquerytoArchive";
						view = "vwtoArchive";
						dataid = "querydataList";
						dbpath="/"+$.hori.getconfig().docServer+"/genertec/dep1/qsbg_1.nsf";
						Bstart=Bstart+10;
						start=Bstart;
					}
					if(type=="queryArchvied"){
						template="Archvied";
						view = "vwDocByArchvied";
						dataid = "querydataList";
						dbpath="/"+$.hori.getconfig().docServer+"/genertec/dep1/qsbg_1.nsf";
						Cstart=Cstart+10;
						start=Cstart;
					}
					if(type=="searchqueryArchvied"){
						template="searchqueryArchvied";
						view = "vwDocByArchvied";
						dataid = "querydataList";
						dbpath="/"+$.hori.getconfig().docServer+"/genertec/dep1/qsbg_1.nsf";
						Cstart=Cstart+10;
						start=Cstart;
					}
					if(type=="signForDoing"){
						template="signForDoing";
						view = "vwDocByDate";
						dataid = "signdataList";
						dbpath = localStorage.getItem("singdbPath");
						dstart=dstart+10;
						start=dstart;
					}
					if(type=="searchsignForDoing"){
						template="searchsignForDoing";
						view = "vwDocByDate";
						dataid = "signdataList";
						dbpath = localStorage.getItem("singdbPath");
						dstart=dstart+10;
						start=dstart;
					}
					if(type=="signtoArchive"){
						template="signtoArchive";
						view = "vwtoArchive";
						dataid = "signdataList";
						dbpath = localStorage.getItem("singdbPath");
						estart=estart+10;
						start=estart;
					}
					if(type=="searchsigntoArchive"){
						template="searchsigntoArchive";
						view = "vwtoArchive";
						dataid = "signdataList";
						dbpath = localStorage.getItem("singdbPath");
						estart=estart+10;
						start=estart;
					}
					if(type=="signArchvied"){
						template="signArchvied";
						view = "vwDocByArchived";
						dataid = "signdataList";
						dbpath = localStorage.getItem("singdbPath");
						fstart=fstart+10;
						start=fstart;
					}
					if(type=="searchsignArchvied"){
						template="searchsignArchvied";
						view = "vwDocByArchived";
						dataid = "signdataList";
						dbpath = localStorage.getItem("singdbPath");
						fstart=fstart+10;
						start=fstart;
					}
					var searchVal = localStorage.getItem("searchVal");
					var searchkey = localStorage.getItem("searchkey");
					if(searchVal=="no"){
						var url=$.hori.getconfig().appServerHost+"view/oa/"+template+dbpath+"/myview?openform&view="+view+"&start="+start+"&count=10";
					}else if(searchVal=="yes"){
						var url=$.hori.getconfig().appServerHost+"view/oa/"+template+dbpath+"/"+view+"?searchview&count=10&query="+searchkey+"&view="+view+"&start="+start;
					}
					//alert(url);
					$.hori.ajax({
						"type":"post",
						"url":url,
						"success":function(res){
							$("#moredata").remove();
							if(res.indexOf("无内容")!="-1"){
								var divs = document.getElementsByName("more");
								for(var i=0; i<divs.length; i++)
								{
									divs[i].style.display='none';
								}
							}
							$("#"+dataid).append(res).listview("refresh");
							localStorage.setItem("pullUpActionVal","yes");
							fiteryear();
							myStartTaskLoad=true;
							myScroll.refresh();
							$.hori.hideLoading();
						},
						"error":function(res){
							alert(res);
							$.hori.hideLoading();
						}
					});
					} catch (e) {
						alert(e.message);
					}
				}, 1000);
			}
			function loaded() {
				pullUpEl = document.getElementById('pullUp');	
				pullUpOffset = pullUpEl.offsetHeight;
				
			myScroll = new iScroll('wrapper', {
				useTransition: true,
				topOffset: pullUpOffset,
				onRefresh: function () {
				if (pullUpEl.className.match('loading')) {
						pullUpEl.className = '';
						pullUpEl.querySelector('.pullUpLabel').innerHTML = '';
					}
				},
			onScrollMove: function () {
				if (this.y < (this.maxScrollY - 5) && !pullUpEl.className.match('flip')) {
					pullUpEl.className = 'flip';
					pullUpEl.querySelector('.pullUpLabel').innerHTML = '';
					this.maxScrollY = this.maxScrollY;
				} else if (this.y > (this.maxScrollY + 5) && pullUpEl.className.match('flip')) {
					pullUpEl.className = '';
					pullUpEl.querySelector('.pullUpLabel').innerHTML = '';
					this.maxScrollY = pullUpOffset;
				}
			},
			onScrollEnd: function () {
				if (pullUpEl.className.match('flip')) {
					pullUpEl.className = 'loading';
					pullUpEl.querySelector('.pullUpLabel').innerHTML = '';
					pullUpAction();
				}
			}
		});
		}
</script>
	<script>
	var  loded="1"
		var singdbPath ="";
		var template = "";
		var tabid="queryList";
		$(document).ready(function(){
			var hori = $.hori;
			/*设置标题*/
			hori.setHeaderTitle("集团文件系统公文查阅");
			//获取会签tab
			getsignpath();
			
			$("#tab").tabs({beforeActivate:function(event,ui){
				//alert(ui.newTab.context.dataset.id);
				tabid=ui.newTab.context.dataset.id;
				//内请
				if(tabid=="queryList"){
					queryListForType($('#querytype').val());
					$("#moredata").remove();
					$("#queryselect").css("display", "block");
					$("#querySearch").css("display", "block");
					$("#signselect").css("display", "none");
					$("#signSearch").css("display", "none");
					$("#querysearchKey").val("请输入关键字");
					$("#querysearchKey").attr("style","color: #ADADAD;");
				}
				//会签
				if(tabid=="signList"){
					signListForType($('#signtype').val());
					$("#moredata").remove();
					$("#signselect").css("display", "block");
					$("#signSearch").css("display", "block");
					$("#queryselect").css("display", "none");
					$("#querySearch").css("display", "none");
					$("#signsearchKey").val("请输入关键字");
					$("#signsearchKey").attr("style","color: #ADADAD;");
				}
		}})
			var onlist=localStorage.getItem("click4");
			if(onlist=="1"){
				$("#ui-id-1").click()	
			}
			if(onlist=="2"){
				$("#ui-id-2").click()	
			}
			if(tabid=="queryList"){
				queryListForType($('#querytype').val());
			}
			hori.registerEvent("case", "casePresented", function() {
				var onlist=localStorage.getItem("click4");
				if(onlist=="1"){
					$("#ui-id-1").click()	
				}
				if(onlist=="2"){
					$("#ui-id-2").click()	
				}
			});
			
		})
		</script>
		<script type="text/javascript">
		//内请切换
		function queryListForType(view){
			$.hori.showLoading();
			Astart=1;Bstart=1;Cstart=1;
			localStorage.setItem("searchVal", "no");
			if(view=="vwDocByDate"){
				template="queryForDoing";
				localStorage.setItem("type","querydoing");
			}
			if(view=="vwtoArchive"){
				template="toArchive";
				localStorage.setItem("type","querytoArchive");
			}
			if(view=="vwDocByArchvied"){
				localStorage.setItem("type","queryArchvied");
				template="Archvied";
				view="vwDocByArchvied";
			}
			$.hori.hideLoading();
			var url=$.hori.getconfig().appServerHost+"view/oa/"+template+"/"+$.hori.getconfig().docServer+"/genertec/dep1/qsbg_1.nsf/myview?openform&view="+view+"&start=1&count=30";
			$.hori.ajax({
				"type":"post",
				"url":url,
				"success":function(res){
					$("#querydataList").empty();
					$("#signdataList").empty();
					$("#querydataList").append(res).listview("refresh");
					if(loded==1){
						loaded();
						loded=loded+1;
					}
					taskListNum = $("#querydataList li").length;
					localStorage.setItem("querydataListHide","querydataList");
					localStorage.setItem("pullUpActionVal","yes");
					fiteryear();
					$("#moredata").hide();
					$("#querysearchKey").val("请输入关键字");
					$("#querysearchKey").attr("style","color: #ADADAD;");
					myScroll.refresh();
					signLoad=true;
					$.hori.hideLoading();
				},
				"error":function(res){
					alert(res);
					$.hori.hideLoading();
				}
			});
		}
		
		//获取会签类型库
		function getsignpath(){
			$.hori.ajax({
				"type":"post",
				"url":$.hori.getconfig().appServerHost+"/view/oa/signtype/"+$.hori.getconfig().docServer+"/genertec/mgrengine.nsf/createNavigator?openAgent&divIndex=001",
				"success":function(res){
					singdbPath = res.substring(0,res.indexOf("nsf"))+"nsf";
					localStorage.setItem("singdbPath",singdbPath);
					$.hori.hideLoading();
				},
				"error":function(res){
					$.hori.hideLoading();
					alert("没获取到会签库路径");
				}
			});
		}

		//会签切换
		function signListForType(value){
			$.hori.showLoading();
			localStorage.setItem("searchVal", "no");
			dstart=1;estart=1;fstart=1;
			if(value=="doing"){
				template="signForDoing";
				view="vwDocByDate";
				localStorage.setItem("type","signForDoing");
			}
			if(value=="todo"){
				template="signtoArchive";
				view="vwtoArchive";
				localStorage.setItem("type","signtoArchive");
			}
			if(value=="did"){
				template="signArchvied";
				view="vwDocByArchived";
				localStorage.setItem("type","signArchvied");
			}
			var singdbPath = localStorage.getItem("singdbPath");
			var url=$.hori.getconfig().appServerHost+"view/oa/"+template+"/"+singdbPath+"/myview?openform&view="+view+"&start=1&count=30";
			$.hori.hideLoading();
			$.hori.ajax({
				"type":"post",
				"url":url,
				"success":function(res){
					$("#signdataList").empty();
					$("#querydataList").empty();
					$("#signdataList").append(res).listview("refresh");
					myScroll.refresh();taskListNum = $("#signdataList li").length;
					localStorage.setItem("querydataListHide","signdataList");
					localStorage.setItem("pullUpActionVal","yes");
					$.hori.hideLoading();
					$("#signsearchKey").val("请输入关键字");
					$("#signsearchKey").attr("style","color: #ADADAD;");
                    fiteryear();
					$("#moredata").hide();
				},
				"error":function(res){
					alert(res);
					$.hori.hideLoading();
				}
			});
		}
		//内请表单展示页面
		var y1 = null;//这个设置为全局
		function loadPageForm(str){
			$.hori.showLoading();
			if (y1 == null){
				y1 = new Date().getTime();
			}else{       
				var y2 = new Date().getTime();
				if(y2 - y1 < 500){
					y1 = y2;
					return;
				}else{
					y1 = y2;
				}
			}
			localStorage.setItem("click4","1");
			var templatecon="neiqingsign"
			localStorage.setItem("contemplate",templatecon);
			var unid = $(str).data("unid");
			localStorage.setItem("unid",unid);
			var loadurl= $.hori.getconfig().serverBaseUrl+"viewhome/html/neiqingform.html";
			//alert(loadurl);return;
			$.hori.loadPage(loadurl);
		}
		//会签表单展示页面
		var t1 = null;//这个设置为全局
		function loadsignPageForm(str){
		////vwDocByDate,vwtoArchive,vwDocByArchvied
			$.hori.showLoading();
			if (t1 == null){
				t1 = new Date().getTime();
			}else{       
				var t2 = new Date().getTime();
				if(t2 - t1 < 500){
					t1 = t2;
					return;
				}else{
					t1 = t2;
				}
			}
			localStorage.setItem("click4","2");	
			var templatecon ="contentsign";
			localStorage.setItem("contemplate",templatecon);
			var unid = $(str).data("unid");
			localStorage.setItem("unid",unid);
			//alert(unid);return;
			var loadurl= $.hori.getconfig().serverBaseUrl+"viewhome/html/signform.html";
			$.hori.loadPage(loadurl);
		}
		
		function querysearchlist(){
			var searchkey=$("#querysearchKey").val();
			if(searchkey == ''){
				alert("请输入关键字");
				return;
			}else if(searchkey == '请输入关键字'){
				alert("请输入关键字");
				return;
			}
			localStorage.setItem("searchkey", searchkey);
			//alert(searchkey);
			var view = $('option:selected', '#querytype').val();
			//alert(view);
			$.hori.showLoading();
			Astart=1;Bstart=1;Cstart=1;
			localStorage.setItem("searchVal", "yes");
			if(view=="vwDocByDate"){
				template="searchqueryForDoing";
				localStorage.setItem("type","searchqueryForDoing");
			}
			if(view=="vwtoArchive"){
				template="searchquerytoArchive";
				localStorage.setItem("type","searchquerytoArchive");
			}
			if(view=="vwDocByArchvied"){
				localStorage.setItem("type","searchqueryArchvied");
				template="searchqueryArchvied";
			}
			//
			var url=$.hori.getconfig().appServerHost+"view/oa/"+template+"/"+$.hori.getconfig().docServer+"/genertec/dep1/qsbg_1.nsf/"+view+"?SearchView&count=50&Query="+searchkey+"&view="+view;
			$.hori.ajax({
				"type":"post",
				"url":url,
				"success":function(res){
					$("#querydataList").empty();
					$("#signdataList").empty();
					$("#querydataList").append(res).listview("refresh");
					$.hori.hideLoading();
					taskListNum = $("#querydataList li").length;
					localStorage.setItem("querydataListHide","querydataList");
					localStorage.setItem("pullUpActionVal","yes");
					fiteryear();
					$("#moredata").hide();
					myScroll.refresh();
					signLoad=true;
					$.hori.hideLoading();
				},
				"error":function(res){
					alert(res);
					$.hori.hideLoading();
				}
			});
		}
		function signsearchlist(){
			var searchkey=$("#signsearchKey").val();
			if(searchkey == ''){
				alert("请输入关键字");
				return;
			}else if(searchkey == '请输入关键字'){
				alert("请输入关键字");
				return;
			}
			localStorage.setItem("searchkey", searchkey);
			//alert(searchkey);
			var value = $('option:selected', '#signtype').val();
			//alert(value);
			$.hori.showLoading();
			dstart=1;estart=1;fstart=1;
			localStorage.setItem("searchVal", "yes");
			if(value=="doing"){
				template="searchsignForDoing";
				view="vwDocByDate";
				localStorage.setItem("type","searchsignForDoing");
			}
			if(value=="todo"){
				template="searchsigntoArchive";
				view="vwtoArchive";
				localStorage.setItem("type","searchsigntoArchive");
			}
			if(value=="did"){
				template="searchsignArchvied";
				view="vwDocByArchived";
				localStorage.setItem("type","searchsignArchvied");
			}
			var singdbPath = localStorage.getItem("singdbPath");
			var url=$.hori.getconfig().appServerHost+"view/oa/"+template+"/"+singdbPath+"/"+view+"?SearchView&count=50&Query="+searchkey+"&view="+view;
			//alert(url);
			$.hori.ajax({
				"type":"post",
				"url":url,
				"success":function(res){
					$("#signdataList").empty();
					$("#querydataList").empty();
					$("#signdataList").append(res).listview("refresh");
					taskListNum = $("#signdataList li").length;
					localStorage.setItem("querydataListHide","signdataList");
					localStorage.setItem("pullUpActionVal","yes");
					fiteryear();
					$("#moredata").hide();
					$.hori.hideLoading();
					myScroll.refresh();
				},
				"error":function(res){
					alert(res);
					$.hori.hideLoading();
				}
			});
		}
		//搜索框 signsearchKey
		function clearData2() {
			var signsearchKeyVal = $("#signsearchKey").val();
			$("#signsearchKey").css("color", "#0F0E0E");
			if (signsearchKeyVal == "请输入关键字"){
				$("#signsearchKey").val("");
			} 
		}
		function showTips2() {
			var signsearchKeyVal = $("#signsearchKey").val();
			if (signsearchKeyVal == ""||signsearchKeyVal == " "){
				$("#signsearchKey").val("请输入关键字");
				$("#signsearchKey").attr("style","color: #ADADAD;");
			}
		}
		function clearData() {
			var querysearchKeyVal = $("#querysearchKey").val();
			$("#querysearchKey").attr("style","color: #0F0E0E;");
			if (querysearchKeyVal == "请输入关键字"){
				$("#querysearchKey").val("");
			} 
		}
		function showTips() {
			var querysearchKeyVal = $("#querysearchKey").val();
			if (querysearchKeyVal == ""||querysearchKeyVal == " "){
				$("#querysearchKey").val("请输入关键字");
				$("#querysearchKey").attr("style","color: #ADADAD;");
			}
		}
	</script>
		<style>
		#wrapper {
			position: fixed;
			top: 195px;
			bottom: 48px;
			width: 85%;
			overflow: scroll;
		}
	</style>
</head>
<body>
	<div  style="margin:0px;padding:0px;">
		<div data-role="content">
			<div data-role="tabs" id="tab">
		      	<div data-role="navbar">
				    <ul>
				      <li><a href="#two" data-ajax="false" data-id="queryList">集团内请</a></li>
				      <li><a href="#three" data-ajax="false" data-id="signList">部门会签</a></li>
				    </ul>
		      	</div>
				<div id="queryselect" align="center" class="ui-grid-b">
						<div class="ui-block-a" style="min-width:10em">
							<select name="querytype" data-mini="true" id="querytype" onChange="queryListForType(this.value)" data-theme="a"  data-native-menu="true">
							<option value="vwDocByDate">办理中</option>
							<option value="vwtoArchive">待归档</option>
							<option value="vwDocByArchvied">已归档</option>
							</select>
						</div>
						<div class="ui-block-b"></div>
						<div class="ui-block-c"></div>
				</div>
				<div id="querySearch">
					<table>
						<tr>
							<td width="93%" height="20px"><input id="querysearchKey" type="text" value="请输入关键字" style="color: #ADADAD;" onfocus="clearData()" onblur="showTips()"/></td>
							<td><a href="#" onclick="querysearchlist()" data-role="button" data-mini='true' data-theme="f" class="ui-btn-corner-all ui-btn-up-c ui-btn-up-f ui-btn ui-btn-inline ui-shadow" style="color: white">搜索</a></td>
						</tr>
						<tr><td style="color: gray;">列表最多显示近期30个文件，更多请搜索。</td><tr>
					</table>
				</div>
				<div id="signselect" align="center" class="ui-grid-b" style="display:none">
						<div class="ui-block-a"></div>
						<div class="ui-block-b"></div>
						<div class="ui-block-c" style="min-width:10em">
							<select name="signtype" data-mini="true" id="signtype" onChange="signListForType(this.value)" data-theme="a"  data-native-menu="true">
								<option value="doing">办理中</option>
								<option value="todo">待归档</option>
								<option value="did">已归档</option>
							</select>
						</div>
				</div>
				<div id="signSearch" style="display:none">
					<table>
						<tr>
							<td width="93%" height="20px"><input id="signsearchKey" type="text" value="请输入关键字" style="color: #ADADAD;" onfocus="clearData2()" onblur="showTips2()"/></td>
							<td><a href="#" onclick="signsearchlist()" data-role="button" data-inline="true" data-theme="f" class="ui-btn-corner-all ui-btn-up-c ui-btn-up-f ui-btn ui-btn-inline ui-shadow" style="color: white">搜索</a></td>
						</tr>
						<tr><td style="color: gray;">列表最多显示近期30个文件，更多请搜索。</td><tr>
					</table>
				</div>
				<div id="wrapper">
					<div id="scroller">
						<div id="pullDown"></div>
			      <div id="two">
						<ul id="querydataList"  data-role="listview" data-inset="true" style="margin-top: 25px;">
							<li id="moredata" style="display:none"><div id="pullUp" align="center">
								<span class="pullUpLabel">上划加载更多...</span>
							</div></li>
						</ul>
						<br/>
			      </div>
			      <div id="three">
					   <ul id="signdataList" data-role="listview" data-inset="true" style="margin-top: 25px;">
							<li id="moredata" style="display:none"><div id="pullUp" align="center">
									<span class="pullUpLabel">上划加载更多...</span>
								</div></li>
					   </ul>
						<br/>
			      </div>
		    </div>
			</div>
			</div>			
		</div>	
	</div>		
</body>
</html>

